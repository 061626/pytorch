docker_config_defaults: &docker_config_defaults
  user: jenkins
  aws_auth:
    aws_access_key_id: AKIAIUHRTFRLXI6HBUCQ
    aws_secret_access_key: $CIRCLECI_AWS_SECRET_KEY

version: 2
jobs:
  linux_trusty_py3_6_gcc7_build:
    working_directory: /var/lib/jenkins/workspace
    docker:
      - image: 308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc7:226
        <<: *docker_config_defaults
    resource_class: large
    steps:
    - checkout
    - run:
        name: Build
        command: |
          export SCCACHE_BUCKET=ossci-compiler-cache
          git submodule update --init
          .jenkins/pytorch/build.sh
          .jenkins/pytorch/test.sh
  linux_xenial_cuda9_2_cudnn7_py3_gcc7_build:
    working_directory: /var/lib/jenkins/workspace
    docker:
      - image: 308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7:226
        <<: *docker_config_defaults
    resource_class: large
    steps:
    - checkout
    - run:
        name: Build
        command: |
          export SCCACHE_BUCKET=ossci-compiler-cache
          export TORCH_CUDA_ARCH_LIST=5.2
          git submodule update --init
          .jenkins/pytorch/build.sh
    - persist_to_workspace:
        root: /var/lib/jenkins/workspace/pytorch-ci-env
        paths:
          - "*"
  linux_xenial_cuda9_2_cudnn7_py3_gcc7_test:
    machine:
      image: default
    resource_class: gpu.small
    steps:
    - checkout
    - run:
        name: Prepare workspace
        command: |
          sudo mkdir -p /opt/workspace
          sudo chmod -R 777 /opt/workspace
    - attach_workspace:
        at: /opt/workspace
    - run:
        name: Build
        command: |
          set -x
          sudo pip install awscli
          curl -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
          echo "deb https://nvidia.github.io/libnvidia-container/ubuntu14.04/amd64 /" | sudo tee -a /etc/apt/sources.list.d/nvidia-docker.list
          echo "deb https://nvidia.github.io/nvidia-container-runtime/ubuntu14.04/amd64 /" | sudo tee -a /etc/apt/sources.list.d/nvidia-docker.list
          echo "deb https://nvidia.github.io/nvidia-docker/ubuntu14.04/amd64 /" | sudo tee -a /etc/apt/sources.list.d/nvidia-docker.list
          sudo apt-get update
          sudo apt-get install linux-headers-$(uname -r)
          sudo apt-get install linux-image-generic
          wget 'https://s3.amazonaws.com/ossci-linux/nvidia_driver/NVIDIA-Linux-x86_64-396.26.run'
          sudo /bin/bash ./NVIDIA-Linux-x86_64-396.26.run -s --no-drm
          sudo apt-get install -y nvidia-docker2
          sudo pkill -SIGHUP dockerd
          nvidia-smi
          export AWS_ACCESS_KEY_ID=AKIAIUHRTFRLXI6HBUCQ
          export AWS_SECRET_ACCESS_KEY=$CIRCLECI_AWS_SECRET_KEY
          eval $(aws ecr get-login --region us-east-1 --no-include-email)
          docker pull 308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7:226
          id=$(docker run --runtime=nvidia -t -d -w /var/lib/jenkins 308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7:226)
          pwd
          mkdir -p /home/circleci/project/build
          cp -r /opt/workspace/cpp_test_bin /home/circleci/project/build/bin
          docker cp /home/circleci/project/. "$id:/var/lib/jenkins/workspace"
          echo "mkdir -p /opt/conda/lib/python3.6/site-packages" | docker exec -u jenkins -i "$id" bash
          docker cp "/opt/workspace/torch" "$id:/opt/conda/lib/python3.6/site-packages/torch"
          (echo "export SCCACHE_BUCKET=$SCCACHE_BUCKET" && echo 'sudo chown -R jenkins workspace /opt/conda/lib/python3.6/site-packages/torch && cd workspace && git submodule update --init && .jenkins/pytorch/test.sh') | docker exec -u jenkins -i "$id" bash
  macos_10_13_py3_build:
    macos:
      xcode: "9.0"
    steps:
      - checkout
      - run:
          name: Build
          command: |
            set -ex
            export SCCACHE_BUCKET=ossci-compiler-cache
            export BUILD_ENVIRONMENT=pytorch-macos-10.13-py3
            git submodule update --init
            chmod a+x .jenkins/pytorch/macos-build.sh
            .jenkins/pytorch/macos-build.sh
      - persist_to_workspace:
          root: /Users/distiller/pytorch-ci-env
          paths:
            - "*"
  macos_10_13_py3_test:
    macos:
      xcode: "9.0"
    steps:
      - checkout
      - run:
          name: Prepare workspace
          command: |
            sudo mkdir -p /Users/distiller/pytorch-ci-env
            sudo chmod -R 777 /Users/distiller/pytorch-ci-env
      - attach_workspace:
          at: /Users/distiller/pytorch-ci-env
      - run:
          name: Build
          command: |
            set -ex
            export BUILD_ENVIRONMENT=pytorch-macos-10.13-py3
            git submodule update --init
            chmod a+x .jenkins/pytorch/macos-test.sh
            .jenkins/pytorch/macos-test.sh
workflows:
  version: 2
  build:
    jobs:
      - linux_trusty_py3_6_gcc7_build
      - linux_xenial_cuda9_2_cudnn7_py3_gcc7_build
      - linux_xenial_cuda9_2_cudnn7_py3_gcc7_test:
          requires:
            - linux_xenial_cuda9_2_cudnn7_py3_gcc7_build
      - macos_10_13_py3_build
      - macos_10_13_py3_test:
          requires:
            - macos_10_13_py3_build
